{% extends 'gestion_mantenimiento/layouts/base.html' %}
{% load static %}

{% block titulo_ventana %}Dashboard Mantenimiento | Bomberos{% endblock %}

{% block titulo_pagina %}
    <span class="text-xl color_primario">
        <i class="fas fa-chart-line me-2"></i>Panel de Control
    </span>
{% endblock %}

{% block contenido %}
<div class="container-fluid px-0">

    {# --- SECCIÓN 1: KPIs (Tarjetas Superiores) --- #}
    <div class="row g-4 mb-4">
        {# KPI 1: Pendientes #}
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 border-start border-4 border-warning h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase text-sm font-bold mb-1">Órdenes Activas</h6>
                        <h2 class="font-bold text-dark mb-0 text-2xl">{{ kpi_pendientes }}</h2>
                        <small class="text-warning text-xs">Requieren atención</small>
                    </div>
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                        <i class="fas fa-clipboard-list fa-2x"></i>
                    </div>
                </div>
                
                {# PERMISO: Ver órdenes #}
                {% if perms.gestion_usuarios.accion_gestion_mantenimiento_ver_ordenes %}
                <a href="{% url 'gestion_mantenimiento:ruta_lista_ordenes' %}?estado=activos" class="card-footer bg-white border-0 text-muted text-xs text-decoration-none stretched-link">
                    Ver detalles <i class="fas fa-chevron-right ms-1"></i>
                </a>
                {% endif %}
            </div>
        </div>

        {# KPI 2: En Taller #}
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 border-start border-4 border-danger h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase text-sm font-bold mb-1">Equipos en Taller</h6>
                        <h2 class="font-bold text-dark mb-0 text-2xl">{{ kpi_en_taller }}</h2>
                        <small class="text-danger text-xs">No operativos</small>
                    </div>
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger">
                        <i class="fas fa-tools fa-2x"></i>
                    </div>
                </div>
                {# Nota: Idealmente dirigiría a inventario filtrado, por ahora al home #}
                <span class="card-footer bg-white border-0 text-muted text-xs">
                    Indisponibles en Inventario
                </span>
            </div>
        </div>

        {# KPI 3: Planes #}
        <div class="col-12 col-md-4">
            <div class="card shadow-sm border-0 border-start border-4 border-info h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted text-uppercase text-sm font-bold mb-1">Planes Recurrentes</h6>
                        <h2 class="font-bold text-dark mb-0 text-2xl">{{ kpi_planes }}</h2>
                        <small class="text-info text-xs">Automatizados</small>
                    </div>
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info">
                        <i class="fas fa-sync-alt fa-2x"></i>
                    </div>
                </div>
                
                {# PERMISO: Gestionar Planes #}
                {% if perms.gestion_usuarios.accion_gestion_mantenimiento_gestionar_planes %}
                <a href="{% url 'gestion_mantenimiento:ruta_lista_planes' %}" class="card-footer bg-white border-0 text-muted text-xs text-decoration-none stretched-link">
                    Configurar planes <i class="fas fa-chevron-right ms-1"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        {# --- SECCIÓN 2: Gráfico y Resumen --- #}
        <div class="col-12 col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3">
                    <h6 class="card-title mb-0 font-bold text-secondary text-lg">Estado Global de Órdenes</h6>
                </div>
                <div class="card-body">
                    <div class="position-relative" style="height: 250px;">
                        <canvas id="chartEstadoOrdenes"></canvas>
                    </div>
                    <div class="mt-3 text-center text-xs text-muted">
                        Distribución histórica de todas las órdenes generadas.
                    </div>
                </div>
            </div>
        </div>

        {# --- SECCIÓN 3: Urgencias y Acciones --- #}
        <div class="col-12 col-lg-7">
            
            {# Acciones Rápidas #}
            <div class="card shadow-sm border-0 mb-4 bg-primary text-white" style="background: linear-gradient(45deg, #1a237e 0%, #3949ab 100%);">
                <div class="card-body p-4 d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="font-bold mb-1 text-lg">¿Falla imprevista?</h5>
                        <p class="mb-0 text-white-50 text-sm">Reporta y gestiona reparaciones urgentes de inmediato.</p>
                    </div>
                    
                    {# PERMISO: Gestionar Órdenes (Crear) #}
                    {% if perms.gestion_usuarios.accion_gestion_mantenimiento_gestionar_ordenes %}
                    <a href="{% url 'gestion_mantenimiento:ruta_crear_orden_correctiva' %}" class="btn btn-light text-primary font-bold shadow-sm text-sm">
                        <i class="fas fa-plus-circle me-2"></i>Crear Correctiva
                    </a>
                    {% endif %}
                </div>
            </div>

            {# Tabla de Próximos Vencimientos #}
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0 font-bold text-secondary text-lg">Atención Prioritaria</h6>
                    <small class="text-muted text-xs">Próximos vencimientos</small>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-sm text-uppercase">
                            <tr>
                                <th class="ps-4">Orden</th>
                                <th>Fecha Programada</th>
                                <th>Estado</th>
                                <th class="text-end pe-4">Acción</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            {% for orden in ordenes_urgentes %}
                            <tr>
                                <td class="ps-4">
                                    <div class="font-bold text-dark text-base">
                                        {% if orden.plan_origen %}
                                            {{ orden.plan_origen.nombre }}
                                        {% else %}
                                            Mantenimiento Correctivo
                                        {% endif %}
                                    </div>
                                    <small class="text-muted text-xs text-data-code">#{{ orden.id }} &bull; {{ orden.activos_afectados.count }} Activos</small>
                                </td>
                                <td>
                                    {% if orden.fecha_programada.date < hoy.date %}
                                        <span class="badge bg-danger text-xs">Vencida {{ orden.fecha_programada|date:"d/m" }}</span>
                                    {% elif orden.fecha_programada.date == hoy.date %}
                                        <span class="badge bg-warning text-dark text-xs">Hoy</span>
                                    {% else %}
                                        <span class="text-dark font-bold text-data-code">{{ orden.fecha_programada|date:"d/m/Y" }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if orden.estado == 'EN_CURSO' %}
                                        <span class="text-primary font-bold text-xs"><i class="fas fa-spinner fa-spin me-1"></i> En Curso</span>
                                    {% else %}
                                        <span class="text-secondary text-xs">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    {# PERMISO: Ver órdenes (para acceder al detalle) #}
                                    {% if perms.gestion_usuarios.accion_gestion_mantenimiento_ver_ordenes %}
                                    <a href="{% url 'gestion_mantenimiento:ruta_gestionar_orden' orden.pk %}" class="btn btn-sm btn-outline-primary text-xs">
                                        <i class="fas fa-arrow-right"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted text-sm">
                                    <i class="fas fa-check-circle text-success mb-2 fs-4"></i><br>
                                    ¡Todo al día! No hay órdenes pendientes urgentes.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
{# --- Scripts Gráficos --- #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('chartEstadoOrdenes').getContext('2d');
        
        // Datos inyectados desde Django View
        const labels = JSON.parse('{{ chart_labels|safe }}');
        const dataValues = JSON.parse('{{ chart_data|safe }}');

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: dataValues,
                    backgroundColor: [
                        '#6c757d', // Pendiente (Gris)
                        '#ffc107', // En Curso (Amarillo)
                        '#198754', // Realizada (Verde)
                        '#212529'  // Cancelada (Negro)
                    ],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            boxWidth: 10
                        }
                    }
                },
                cutout: '70%' // Hace el agujero de la dona más grande
            }
        });
    });
</script>
{% endblock scripts %}